import{j as r,L as $,X as P,b as q,e as K}from"./ui-vendor-5MgJaMcm.js";import{a as e}from"./react-vendor-uDOJF2jQ.js";import{t as H,w as O}from"./index.js";import{w as G,C as X}from"./FeatureInfoButton-DEmjGvDG.js";const Y=t=>{const n=Math.floor(t/60),u=Math.floor(t%60);return`${n}:${u.toString().padStart(2,"0")}`},Z=[/^untertitel/i,/amara\.org/i,/vielen dank f[Ã¼u]r'?s? zusch/i,/bis zum n[Ã¤a]chsten mal/i,/thank you for watching/i,/subscribe/i,/^\.+$/,/^[â™ªâ™«ðŸŽµðŸŽ¶\s]+$/,/^\s*$/,/^(Ã¤hm?|uhm?|hmm?|ja|nein|ok|okay)\.?\s*$/i],_=t=>{if(!t||typeof t!="string")return!0;const n=t.trim();if(n.length<10)return!0;for(const u of Z)if(u.test(n))return console.log("[AudioRecorder] Filtered hallucination:",n),!0;return!1},J=({isRecording:t,analyserNode:n})=>{const u=e.useRef(null),f=e.useRef(null);return e.useEffect(()=>{if(!t||!n||!u.current){f.current&&cancelAnimationFrame(f.current);return}const s=u.current,g=s.getContext("2d"),E=n.frequencyBinCount,v=new Uint8Array(E),z=()=>{if(!t)return;n.getByteFrequencyData(v),g.clearRect(0,0,s.width,s.height);const A=50,x=2,d=(s.width-A*x)/(A-1),I=s.height/2;for(let a=0;a<A;a++){const M=Math.floor(a/A*E),D=v[M]||0,m=Math.max(2,D/255*(s.height*.8));g.fillStyle=X.slate[800],g.fillRect(a*(x+d),I-m/2,x,m)}f.current=requestAnimationFrame(z)};return z(),()=>{f.current&&cancelAnimationFrame(f.current)}},[t,n]),r.jsx("canvas",{ref:u,width:200,height:32,className:"flex-1 max-w-[300px] min-w-[80px] sm:min-w-[100px]"})},te=({onTranscriptReady:t,disabled:n=!1,warmUp:u=!1,deviceId:f=null})=>{const[s,g]=e.useState(!1),[E,v]=e.useState(!1),[z,A]=e.useState(!1),[x,d]=e.useState(0),[I,a]=e.useState(null),[M,D]=e.useState(!1),m=e.useRef(null),C=e.useRef([]),w=e.useRef(null),b=e.useRef(null),h=e.useRef(null),R=e.useRef(null),N=e.useRef(!1),j=e.useRef(0),k=e.useRef(null),W=e.useCallback(()=>{const c={echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0};return f&&(c.deviceId={exact:f}),c},[f]);e.useEffect(()=>{u&&!M&&(async()=>{try{console.log("[AudioRecorder] Warming up microphone..."),(await navigator.mediaDevices.getUserMedia({audio:W()})).getTracks().forEach(S=>S.stop()),D(!0),console.log("[AudioRecorder] Microphone warm-up complete")}catch(y){console.warn("[AudioRecorder] Warm-up failed:",y.message)}})()},[u,M]);const p=e.useCallback(()=>{b.current&&(clearInterval(b.current),b.current=null),k.current&&(clearInterval(k.current),k.current=null),w.current&&(w.current.getTracks().forEach(c=>c.stop()),w.current=null),h.current&&(h.current.close(),h.current=null),C.current=[],N.current=!1,j.current=0},[]);e.useEffect(()=>p,[p]);const B=async()=>{try{a(null);const c=await navigator.mediaDevices.getUserMedia({audio:W()});w.current=c,h.current=new(window.AudioContext||window.webkitAudioContext);const y=h.current.createMediaStreamSource(c);R.current=h.current.createAnalyser(),R.current.fftSize=256,y.connect(R.current);const S=O()||"audio/webm",o=new MediaRecorder(c,{mimeType:S});m.current=o,C.current=[],o.ondataavailable=l=>{l.data.size>0&&C.current.push(l.data)},o.start(100),g(!0),d(0),N.current=!1,j.current=0,b.current=setInterval(()=>{d(l=>l+1)},1e3);const i=new Uint8Array(R.current.frequencyBinCount);k.current=setInterval(()=>{if(R.current){R.current.getByteFrequencyData(i);const l=i.reduce((T,F)=>T+F,0)/i.length;l>j.current&&(j.current=l),l>20&&(N.current=!0)}},100)}catch(c){console.error("[AudioRecorder] Error starting recording:",c),a("Mikrofon-Zugriff verweigert")}},L=e.useCallback(()=>{m.current&&s&&m.current.stop(),p(),g(!1),d(0),a(null)},[s,p]),U=e.useCallback(async()=>{if(!m.current||!s)return;const c=N.current,y=j.current,S=x;if(m.current.stop(),g(!1),b.current&&(clearInterval(b.current),b.current=null),k.current&&(clearInterval(k.current),k.current=null),w.current&&(w.current.getTracks().forEach(o=>o.stop()),w.current=null),h.current&&(h.current.close(),h.current=null),await new Promise(o=>setTimeout(o,100)),C.current.length===0){a("Keine Aufnahme");return}if(S<1){a("Aufnahme zu kurz"),p(),d(0);return}if(!c||y<15){console.log("[AudioRecorder] No speech detected. Peak level:",y),a("Keine Sprache erkannt"),p(),d(0);return}v(!0),a(null);try{const o=m.current?.mimeType||"audio/webm",i=new Blob(C.current,{type:o});if(i.size<1e3)throw new Error("Aufnahme zu kurz");const l=await H(i),T=await G.transcribeAudio(l,o);if(T.transcript){if(_(T.transcript))throw new Error("Keine verstÃ¤ndliche Sprache erkannt");t(T.transcript),p(),d(0)}else throw new Error("Keine Transkription erhalten")}catch(o){console.error("[AudioRecorder] Transcription error:",o);let i=o.message||"Transkription fehlgeschlagen";(i.includes("Failed to fetch")||i.includes("NetworkError"))&&(i="Keine Internetverbindung"),a(i),p(),d(0)}finally{v(!1)}},[s,x,t,p]);return E?r.jsxs("div",{className:"flex items-center justify-center gap-2 px-4 py-3 bg-slate-100 rounded-full border border-slate-200",children:[r.jsx($,{size:24,className:"text-slate-500 animate-spin"}),r.jsx("span",{className:"text-base text-slate-500 hidden sm:inline",children:"Wird transkribiert..."})]}):s?r.jsxs("div",{className:"flex items-center gap-2 sm:gap-3 px-2 sm:px-3 py-2 bg-slate-100 rounded-full border border-slate-200",children:[r.jsx("button",{onClick:L,className:"w-10 h-10 sm:w-11 sm:h-11 rounded-full border-none bg-slate-200 text-slate-500 cursor-pointer flex items-center justify-center transition-all shrink-0 hover:bg-slate-300",children:r.jsx(P,{size:20,strokeWidth:2.5})}),r.jsx(J,{isRecording:s,analyserNode:R.current}),r.jsx("span",{className:"font-sans text-base sm:text-lg font-medium text-slate-800 min-w-[40px] text-right shrink-0",children:Y(x)}),r.jsx("button",{onClick:U,className:"w-10 h-10 sm:w-11 sm:h-11 rounded-full border-none bg-primary text-white cursor-pointer flex items-center justify-center transition-all shrink-0 hover:opacity-90",children:r.jsx(q,{size:20,strokeWidth:2.5})})]}):r.jsxs("div",{className:"flex items-center gap-2",children:[I&&r.jsx("span",{className:"text-sm text-red-500 hidden sm:inline",children:I}),r.jsx("button",{onClick:B,disabled:n,title:"Spracheingabe",className:`w-11 h-11 sm:w-[52px] sm:h-[52px] rounded-full border-none bg-slate-800 text-white flex items-center justify-center transition-all ${n?"cursor-not-allowed opacity-50":"cursor-pointer hover:opacity-90"}`,children:r.jsx(K,{size:22,className:"sm:w-6 sm:h-6"})})]})};export{te as A};
