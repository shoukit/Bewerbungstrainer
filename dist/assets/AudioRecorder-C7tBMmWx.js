import{j as o,l as B,X as L,n as W,p as D}from"./ui-vendor-BAEfSb-X.js";import{a as t}from"./react-vendor-uDOJF2jQ.js";import{w as F,x as q}from"./index.js";import{w as H}from"./formatting-D8kxjF5h.js";import{u as K}from"./useBranding-CvtU4d75.js";const P=s=>{const n=Math.floor(s/60),e=Math.floor(s%60);return`${n}:${e.toString().padStart(2,"0")}`},U=[/^untertitel/i,/amara\.org/i,/vielen dank f[Ã¼u]r'?s? zusch/i,/bis zum n[Ã¤a]chsten mal/i,/thank you for watching/i,/subscribe/i,/^\.+$/,/^[â™ªâ™«ðŸŽµðŸŽ¶\s]+$/,/^\s*$/,/^(Ã¤hm?|uhm?|hmm?|ja|nein|ok|okay)\.?\s*$/i],N=s=>{if(!s||typeof s!="string")return!0;const n=s.trim();if(n.length<10)return!0;for(const e of U)if(e.test(n))return console.log("[AudioRecorder] Filtered hallucination:",n),!0;return!1},G=({isRecording:s,analyserNode:n,b:e})=>{const l=t.useRef(null),p=t.useRef(null);return t.useEffect(()=>{if(!s||!n||!l.current){p.current&&cancelAnimationFrame(p.current);return}const x=l.current,w=x.getContext("2d"),C=n.frequencyBinCount,f=new Uint8Array(C),v=()=>{if(!s)return;n.getByteFrequencyData(f),w.clearRect(0,0,x.width,x.height);const i=50,d=2,b=(x.width-i*d)/(i-1),g=x.height/2;for(let a=0;a<i;a++){const u=Math.floor(a/i*C),m=f[u]||0,R=Math.max(2,m/255*(x.height*.8));w.fillStyle=e.textMain,w.fillRect(a*(d+b),g-R/2,d,R)}p.current=requestAnimationFrame(v)};return v(),()=>{p.current&&cancelAnimationFrame(p.current)}},[s,n,e]),o.jsx("canvas",{ref:l,width:200,height:32,style:{flex:1,maxWidth:"300px",minWidth:"100px"}})},J=({onTranscriptReady:s,disabled:n=!1})=>{const e=K(),[l,p]=t.useState(!1),[x,w]=t.useState(!1),[C,f]=t.useState(0),[v,i]=t.useState(null),d=t.useRef(null),b=t.useRef([]),g=t.useRef(null),a=t.useRef(null),u=t.useRef(null),m=t.useRef(null),R=t.useRef(!1),A=t.useRef(0),k=t.useRef(null),y=t.useCallback(()=>{a.current&&(clearInterval(a.current),a.current=null),k.current&&(clearInterval(k.current),k.current=null),g.current&&(g.current.getTracks().forEach(r=>r.stop()),g.current=null),u.current&&(u.current.close(),u.current=null),b.current=[],R.current=!1,A.current=0},[]);t.useEffect(()=>y,[y]);const I=async()=>{try{i(null);const r=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}});g.current=r,u.current=new(window.AudioContext||window.webkitAudioContext);const T=u.current.createMediaStreamSource(r);m.current=u.current.createAnalyser(),m.current.fftSize=256,T.connect(m.current);const z=q()||"audio/webm",c=new MediaRecorder(r,{mimeType:z});d.current=c,b.current=[],c.ondataavailable=h=>{h.data.size>0&&b.current.push(h.data)},c.start(100),p(!0),f(0),R.current=!1,A.current=0,a.current=setInterval(()=>{f(h=>h+1)},1e3);const S=new Uint8Array(m.current.frequencyBinCount);k.current=setInterval(()=>{if(m.current){m.current.getByteFrequencyData(S);const h=S.reduce((j,$)=>j+$,0)/S.length;h>A.current&&(A.current=h),h>20&&(R.current=!0)}},100)}catch(r){console.error("[AudioRecorder] Error starting recording:",r),i("Mikrofon-Zugriff verweigert")}},M=t.useCallback(()=>{d.current&&l&&d.current.stop(),y(),p(!1),f(0),i(null)},[l,y]),E=t.useCallback(async()=>{if(!d.current||!l)return;const r=R.current,T=A.current,z=C;if(d.current.stop(),p(!1),a.current&&(clearInterval(a.current),a.current=null),k.current&&(clearInterval(k.current),k.current=null),g.current&&(g.current.getTracks().forEach(c=>c.stop()),g.current=null),u.current&&(u.current.close(),u.current=null),await new Promise(c=>setTimeout(c,100)),b.current.length===0){i("Keine Aufnahme");return}if(z<1){i("Aufnahme zu kurz"),y(),f(0);return}if(!r||T<15){console.log("[AudioRecorder] No speech detected. Peak level:",T),i("Keine Sprache erkannt"),y(),f(0);return}w(!0),i(null);try{const c=d.current?.mimeType||"audio/webm",S=new Blob(b.current,{type:c});if(S.size<1e3)throw new Error("Aufnahme zu kurz");const h=await F(S),j=await H.transcribeAudio(h,c);if(j.transcript){if(N(j.transcript))throw new Error("Keine verstÃ¤ndliche Sprache erkannt");s(j.transcript),y(),f(0)}else throw new Error("Keine Transkription erhalten")}catch(c){console.error("[AudioRecorder] Transcription error:",c),i(c.message||"Transkription fehlgeschlagen"),y(),f(0)}finally{w(!1)}},[l,C,s,y]);return x?o.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",gap:e.space[2],padding:`${e.space[3]} ${e.space[4]}`,backgroundColor:e.cardBgHover,borderRadius:e.radius.full,border:`1px solid ${e.borderColor}`},children:[o.jsx(B,{size:e.iconSize["2xl"],color:e.textSecondary,style:{animation:"spin 1s linear infinite"}}),o.jsx("span",{style:{fontSize:e.fontSize.base,color:e.textSecondary},children:"Wird transkribiert..."}),o.jsx("style",{children:"@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }"})]}):l?o.jsxs("div",{style:{display:"flex",alignItems:"center",gap:e.space[3],padding:`${e.space[2]} ${e.space[3]}`,backgroundColor:e.cardBgHover,borderRadius:e.radius.full,border:`1px solid ${e.borderColor}`},children:[o.jsx("button",{onClick:M,style:{width:"44px",height:"44px",borderRadius:e.radius.full,border:"none",backgroundColor:e.borderColorLight,color:e.textSecondary,cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",transition:`all ${e.transition.fast}`,flexShrink:0},onMouseEnter:r=>{r.currentTarget.style.backgroundColor=e.borderColor},onMouseLeave:r=>{r.currentTarget.style.backgroundColor=e.borderColorLight},children:o.jsx(L,{size:20,strokeWidth:2.5})}),o.jsx(G,{isRecording:l,analyserNode:m.current,b:e}),o.jsx("span",{style:{fontFamily:"system-ui, -apple-system, sans-serif",fontSize:e.fontSize.lg,fontWeight:e.fontWeight.medium,color:e.textMain,minWidth:"40px",textAlign:"right",flexShrink:0},children:P(C)}),o.jsx("button",{onClick:E,style:{width:"44px",height:"44px",borderRadius:e.radius.full,border:"none",backgroundColor:e.primaryAccent,color:e.white,cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",transition:`all ${e.transition.fast}`,flexShrink:0},onMouseEnter:r=>{r.currentTarget.style.opacity="0.9"},onMouseLeave:r=>{r.currentTarget.style.opacity="1"},children:o.jsx(W,{size:20,strokeWidth:2.5})})]}):o.jsxs("div",{style:{display:"flex",alignItems:"center",gap:e.space[2]},children:[v&&o.jsx("span",{style:{fontSize:e.fontSize.sm,color:e.error},children:v}),o.jsx("button",{onClick:I,disabled:n,title:"Spracheingabe",style:{width:"52px",height:"52px",borderRadius:e.radius.full,border:"none",backgroundColor:e.textMain,color:e.white,cursor:n?"not-allowed":"pointer",display:"flex",alignItems:"center",justifyContent:"center",transition:`all ${e.transition.fast}`,opacity:n?.5:1},onMouseEnter:r=>{n||(r.currentTarget.style.opacity="0.9")},onMouseLeave:r=>{n||(r.currentTarget.style.opacity="1")},children:o.jsx(D,{size:24})})]})};export{J as A};
