import{g,a as b}from"./gemini-BXO6QR_g.js";import{f as w,h as f,w as l}from"./colors-BQukwKjN.js";function y(r){return!r||typeof r!="string"?r:r.replace(/\\u([0-9a-fA-F]{4})/g,(e,o)=>String.fromCharCode(parseInt(o,16))).replace(new RegExp("(?<!\\\\)u([0-9a-fA-F]{4})","g"),(e,o)=>{const t=parseInt(o,16);return t>=160&&t<=65535?String.fromCharCode(t):e})}function m(r){if(!r||typeof r!="string")return r;let e=r.trim();return e.startsWith("```json")?e=e.replace(/^```json\s*/i,"").replace(/\s*```\s*$/,""):e.startsWith("```")&&(e=e.replace(/^```\s*/,"").replace(/\s*```\s*$/,"")),e.trim()}function p(r,e={}){const{silent:o=!1,context:t="JSON"}=e;if(r==null)return null;if(typeof r=="object")return r;if(typeof r!="string")return o||console.warn(`[parseJSON] Expected string or object, got ${typeof r}`),null;try{let s=m(r);return s=y(s),JSON.parse(s)}catch(s){return o||(console.error(`[parseJSON] Failed to parse ${t}:`,s.message),console.error(`[parseJSON] Input preview: ${r.substring(0,100)}...`)),null}}function $(r){return p(r,{context:"feedback_json"})}function R(r){return p(r,{context:"audio_analysis_json"})}function E(r){if(!r)return[];const e=p(r,{context:"transcript"});return Array.isArray(e)?e:[]}function u(r){if(r==null)return r;if(typeof r=="string")return y(r);if(Array.isArray(r))return r.map(u);if(typeof r=="object"){const e={};for(const o of Object.keys(r))e[o]=u(r[o]);return e}return r}const d=r=>new Promise(e=>setTimeout(e,r));async function O(r,e={},o=null,t=null){if(!r||r.length===0)throw new Error("Transkript ist leer. Das Gespräch muss mindestens einen Austausch enthalten.");const s=F(r,e),n=l.getGeminiApiKey();if(!n)throw new Error("Gemini API Key ist nicht konfiguriert. Bitte kontaktiere den Administrator.");const a={feedbackContent:null,audioAnalysisContent:null},c={roleType:e.role_type||"interview",userRoleLabel:e.user_role_label||"Bewerber",agentRoleLabel:e.interviewer_profile?.role||"Gesprächspartner"};try{const i=e.feedback_prompt||null;a.feedbackContent=await g(s,n,"gemini-1.5-flash",i,c)}catch(i){throw console.error("❌ [Roleplay Feedback] Failed to generate feedback:",i),new Error(`Fehler bei der Feedback-Generierung: ${i.message}`)}if(o){t&&t("audio_analysis");try{a.audioAnalysisContent=await b(o,n,"gemini-1.5-flash",{...c,hasTwoVoices:!0,transcript:s})}catch(i){console.error("❌ [Roleplay Feedback] Failed to generate audio analysis:",i),a.audioAnalysisContent=JSON.stringify({error:!0,summary:"Audio-Analyse konnte nicht durchgeführt werden.",errorMessage:i.message,troubleshooting:["Stelle sicher, dass dein Mikrofon richtig funktioniert","Versuche das Gespräch erneut zu starten","Überprüfe, ob keine andere Anwendung das Mikrofon blockiert"]})}}return a}function F(r,e={}){let o="";e.title&&(o+=`Rollenspiel-Szenario: ${e.title}
`),e.description&&(o+=`Beschreibung: ${e.description}
`),e.variables&&(o+=`
Kontext-Variablen:
`,Object.entries(e.variables).forEach(([n,a])=>{o+=`- ${n}: ${a}
`})),o+=`
--- Gesprächsverlauf ---

`;const t=e.user_role_label||"Bewerber",s=e.interviewer_profile?.role||"Gesprächspartner";return r.forEach(n=>{const a=n.role==="agent"?s:t;o+=`${a}: ${n.text}

`}),o}async function _(r,e,o,t=null,s=0,n=null){try{let a=e;Array.isArray(e)&&(a=JSON.stringify(e));const c={transcript:a,feedback_json:o,duration:s};t&&(c.audio_analysis_json=t),n&&(c.conversation_id=n);const i=await l.request(`/roleplays/sessions/${r}`,{method:"PUT",body:JSON.stringify(c)});if(s>0)try{await l.request(`/roleplays/sessions/${r}/duration`,{method:"POST",body:JSON.stringify({duration_seconds:s})})}catch(h){console.warn("⚠️ [Roleplay Feedback] Failed to update usage limits:",h.message)}return i.data}catch(a){throw console.error("❌ [Roleplay Feedback] ========= SAVE FAILED ========="),console.error("❌ [Roleplay Feedback] Error:",a),console.error("❌ [Roleplay Feedback] Error message:",a.message),new Error(`Fehler beim Speichern der Analyse: ${a.message}`)}}async function N(r){try{return(await l.request(`/roleplays/sessions/${r}`,{method:"GET"})).data}catch(e){throw console.error("❌ [Roleplay Feedback] Failed to load session analysis:",e),new Error(`Fehler beim Laden der Analyse: ${e.message}`)}}async function T(r={}){try{const e=new URLSearchParams(r).toString(),o=e?`/roleplays/sessions?${e}`:"/roleplays/sessions";return await l.request(o,{method:"GET"})}catch(e){throw console.error("❌ [Roleplay Feedback] Failed to load sessions:",e),new Error(`Fehler beim Laden der Sessions: ${e.message}`)}}function k(r){return`${(window.bewerbungstrainerConfig||{apiUrl:"/wp-json/bewerbungstrainer/v1"}).apiUrl}/roleplays/sessions/${r}/audio`}async function j(r,e=10,o=3e3){const t=k(r);for(let s=1;s<=e;s++)try{const n=await fetch(t,{method:"GET",headers:{"X-WP-Nonce":f()},credentials:"same-origin"});if(n.ok){const a=await n.blob();if(a.size===0){if(console.warn("⚠️ [Roleplay Feedback] Audio blob is empty, retrying..."),s<e){await d(o);continue}return null}return a}if(n.status===404&&s<e){await d(o);continue}if(console.error(`❌ [Roleplay Feedback] Failed to fetch audio: HTTP ${n.status}`),s<e){await d(o);continue}}catch(n){if(console.error(`❌ [Roleplay Feedback] Error fetching audio on attempt ${s}:`,n),s<e){await d(o);continue}}return console.warn("⚠️ [Roleplay Feedback] All retry attempts failed, audio not available"),null}async function P(r,e){try{return(await l.request(`/roleplays/sessions/${r}`,{method:"PUT",body:JSON.stringify({conversation_id:e})})).data}catch(o){throw console.error("❌ [Roleplay Feedback] Failed to update session conversation_id:",o),new Error(`Fehler beim Aktualisieren der Session: ${o.message}`)}}async function v(r){try{return(await l.request("/roleplays/sessions",{method:"POST",body:JSON.stringify(r)})).data}catch(e){throw console.error("❌ [Roleplay Feedback] Failed to create session:",e),new Error(`Fehler beim Erstellen der Session: ${e.message}`)}}async function J(){try{const r=await fetch(`${w()}/roleplays`,{headers:{"X-WP-Nonce":f()},credentials:"same-origin"});if(!r.ok)throw new Error("Fehler beim Laden der Szenarien");const e=await r.json();return u(e.data||[])}catch(r){throw console.error("❌ [Roleplay Feedback] Failed to load scenarios:",r),new Error(`Fehler beim Laden der Szenarien: ${r.message}`)}}async function G(r){try{const e=await l.request(`/roleplays/${r}`,{method:"GET"});return u(e.data)}catch(e){throw console.error("❌ [Roleplay Feedback] Failed to load scenario:",e),new Error(`Fehler beim Laden des Szenarios: ${e.message}`)}}export{O as a,N as b,v as c,R as d,$ as e,j as f,J as g,G as h,k as i,T as j,E as p,_ as s,P as u};
