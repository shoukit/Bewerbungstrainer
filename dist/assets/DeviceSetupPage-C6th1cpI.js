import{j as e,w as Q,e as U,L as X,m as Y,ao as G,f as H,E as ee,u as te,C as se,a2 as J,an as q,a7 as re,aa as W}from"./ui-vendor-Cix6Gssq.js";import{a as t}from"./react-vendor-uDOJF2jQ.js";import{b as ae,l as Z}from"./FeatureInfoButton-Ca11wQwo.js";import{M as ne,a as ie,A as le}from"./MicrophoneTestDialog-D3h-xqHO.js";const oe=({type:u,devices:r,selectedDeviceId:n,onDeviceChange:o,isLoading:c,error:x,onRefresh:l,branding:p})=>{const[w,j]=t.useState(!1),D=u==="video"?G:U,k=u==="video"?"Kamera":"Mikrofon",M=s=>{if(s.label){let a=s.label;return a=a.replace(/^Default - /,""),a=a.replace(/^Kommunikation - /,""),a=a.replace(/^Standard - /,""),a.length>40&&(a=a.substring(0,37)+"..."),a}return`${k} ${r.indexOf(s)+1}`},N=r.find(s=>s.deviceId===n),y=s=>{o?.(s),j(!1)};return e.jsxs("div",{className:"relative mb-4",children:[e.jsx("div",{className:"flex flex-wrap gap-3",children:e.jsxs("button",{type:"button",onClick:()=>!c&&j(!w),disabled:c,className:`flex-1 flex items-center justify-between gap-3 px-[18px] py-3.5 rounded-[14px] border-2 transition-all duration-200 ${x?"border-red-500 bg-red-50":"border-slate-200 bg-white"} ${c?"cursor-not-allowed opacity-60":"cursor-pointer"}`,children:[e.jsxs("div",{className:"flex items-center gap-3.5",children:[e.jsx("div",{className:`w-12 h-12 rounded-xl flex items-center justify-center ${x?"bg-red-50":"bg-brand-gradient"}`,children:x?e.jsx(ee,{className:"w-6 h-6 text-red-500"}):e.jsx(D,{className:"w-6 h-6 text-white"})}),e.jsxs("div",{className:"text-left",children:[e.jsx("div",{className:"text-[13px] text-slate-500 font-medium mb-0.5",children:k}),e.jsx("div",{className:`text-[15px] font-semibold ${x?"text-red-700":"text-slate-900"}`,children:c?"Lade...":x||(N?M(N):"Bitte wählen")})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[x&&l&&e.jsx("button",{type:"button",onClick:s=>{s.stopPropagation(),l()},className:"flex items-center justify-center p-2 rounded-lg border-0 bg-slate-50 cursor-pointer",children:e.jsx(te,{className:"w-[18px] h-[18px] text-slate-600"})}),e.jsx(se,{className:`w-[22px] h-[22px] text-slate-400 transition-transform duration-200 ${w?"rotate-180":"rotate-0"}`})]})]})}),w&&r.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("div",{onClick:()=>j(!1),className:"fixed inset-0 z-40"}),e.jsx("div",{className:"absolute top-[calc(100%+8px)] left-0 right-0 bg-white rounded-[14px] shadow-[0_10px_40px_rgba(0,0,0,0.15)] border border-slate-200 z-50 overflow-hidden max-h-[300px] overflow-y-auto",children:r.map((s,a)=>e.jsxs("button",{type:"button",onClick:()=>y(s.deviceId),className:`w-full py-3.5 px-4 text-left flex items-center gap-3 border-0 cursor-pointer transition-colors duration-150 ${n===s.deviceId?"bg-primary/10":"bg-transparent hover:bg-slate-50"}`,children:[e.jsx("div",{className:`w-10 h-10 rounded-[10px] flex items-center justify-center ${n===s.deviceId?"bg-primary":"bg-slate-50"}`,children:e.jsx(D,{className:`w-5 h-5 ${n===s.deviceId?"text-white":"text-slate-400"}`})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:`text-sm font-medium overflow-hidden text-ellipsis whitespace-nowrap ${n===s.deviceId?"text-primary":"text-slate-900"}`,children:M(s)}),s.deviceId==="default"&&e.jsx("div",{className:"text-xs text-slate-400",children:"Systemstandard"})]}),n===s.deviceId&&e.jsx(J,{className:"w-5 h-5 text-primary"})]},s.deviceId||a))})]})]})},pe=({deviceId:u})=>{const[r,n]=t.useState(!1),[o,c]=t.useState(!1),[x,l]=t.useState(0),[p,w]=t.useState(null),[j,D]=t.useState(0),k=t.useRef(null),M=t.useRef(null),N=t.useRef(null),y=t.useRef(null),s=t.useRef(null),a=t.useRef([]),f=t.useRef(null),E=t.useRef(null),A=async()=>{try{w(null),D(0),a.current=[];const i=await navigator.mediaDevices.getUserMedia({audio:u?{deviceId:{exact:u}}:!0});k.current=i;const h=new(window.AudioContext||window.webkitAudioContext);y.current=h;const z=h.createMediaStreamSource(i),S=h.createAnalyser();S.fftSize=256,z.connect(S),M.current=S;const C=new MediaRecorder(i,{mimeType:"audio/webm"});s.current=C,C.ondataavailable=b=>{b.data.size>0&&a.current.push(b.data)},C.onstop=()=>{const b=new Blob(a.current,{type:"audio/webm"});w(b)},C.start(),n(!0);const F=Date.now();E.current=setInterval(()=>{D(Math.floor((Date.now()-F)/1e3))},100);const I=new Uint8Array(S.frequencyBinCount),d=()=>{S.getByteFrequencyData(I);const b=I.reduce((B,K)=>B+K,0)/I.length;l(Math.min(100,b/128*100)),N.current=requestAnimationFrame(d)};d()}catch(i){console.error("Error starting recording:",i)}},L=()=>{E.current&&(clearInterval(E.current),E.current=null),N.current&&(cancelAnimationFrame(N.current),N.current=null),s.current&&s.current.state!=="inactive"&&s.current.stop(),k.current&&(k.current.getTracks().forEach(i=>i.stop()),k.current=null),y.current&&(y.current.close(),y.current=null),n(!1),l(0)},_=()=>{if(!p)return;const i=URL.createObjectURL(p),h=new Audio(i);f.current=h,h.onplay=()=>c(!0),h.onended=()=>{c(!1),URL.revokeObjectURL(i)},h.onerror=()=>{c(!1),URL.revokeObjectURL(i)},h.play()},R=()=>{f.current&&(f.current.pause(),f.current.currentTime=0,f.current=null),c(!1)},T=()=>{R(),w(null),D(0)};return t.useEffect(()=>()=>{L(),R()},[]),t.useEffect(()=>{r&&L(),T()},[u]),e.jsxs("div",{className:"p-4 bg-slate-50 rounded-xl mt-2",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-3 flex-wrap",children:[e.jsx("button",{type:"button",onClick:r?L:A,disabled:o,className:`flex items-center gap-2 px-4 py-2.5 rounded-[10px] border-0 text-white text-sm font-semibold transition-all duration-200 ${r?"bg-red-500":"bg-primary"} ${o?"cursor-not-allowed opacity-60":"cursor-pointer"}`,children:r?e.jsxs(e.Fragment,{children:[e.jsx(q,{className:"w-4 h-4"}),"Stoppen (",Z(j),")"]}):e.jsxs(e.Fragment,{children:[e.jsx(U,{className:"w-4 h-4"}),"Aufnehmen"]})}),p&&!r&&e.jsx("button",{type:"button",onClick:o?R:_,className:`flex items-center gap-2 px-4 py-2.5 rounded-[10px] border-2 border-primary text-primary text-sm font-semibold cursor-pointer transition-all duration-200 ${o?"bg-primary/10":"bg-white"}`,children:o?e.jsxs(e.Fragment,{children:[e.jsx(q,{className:"w-4 h-4"}),"Stoppen"]}):e.jsxs(e.Fragment,{children:[e.jsx(re,{className:"w-4 h-4"}),"Abspielen"]})}),r&&e.jsxs("div",{className:"flex items-center gap-2 text-red-500 text-[13px]",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-red-500 animate-pulse"}),"Aufnahme läuft..."]}),o&&e.jsxs("div",{className:"flex items-center gap-2 text-green-700 text-[13px]",children:[e.jsx(W,{className:"w-4 h-4"}),"Wiedergabe..."]}),p&&!r&&!o&&e.jsxs("div",{className:"flex items-center gap-2 text-slate-500 text-[13px]",children:[e.jsx(J,{className:"w-4 h-4 text-green-500"}),"Aufnahme bereit (",Z(j),")"]})]}),r&&e.jsx(le,{audioLevel:x/100,isActive:!0,variant:"bars",size:"sm"}),!r&&!p&&e.jsxs("p",{className:"m-0 text-[13px] text-slate-500 flex items-center gap-1.5",children:[e.jsx(W,{className:"w-3.5 h-3.5"}),"Nimm etwas auf und spiele es ab, um dein Mikrofon zu testen."]})]})},ce=({deviceId:u})=>{const r=t.useRef(null),n=t.useRef(null),[o,c]=t.useState(null);return t.useEffect(()=>(u&&(async()=>{try{n.current&&n.current.getTracks().forEach(p=>p.stop());const l=await navigator.mediaDevices.getUserMedia({video:u?{deviceId:{exact:u}}:!0});n.current=l,r.current&&(r.current.srcObject=l),c(null)}catch(l){console.error("Error starting camera preview:",l),c("Kamera-Vorschau nicht verfügbar")}})(),()=>{n.current&&n.current.getTracks().forEach(l=>l.stop())}),[u]),o?e.jsx("div",{className:"aspect-video bg-slate-50 rounded-xl flex items-center justify-center text-slate-400 text-sm",children:o}):e.jsx("div",{className:"aspect-video bg-slate-900 rounded-xl overflow-hidden",children:e.jsx("video",{ref:r,autoPlay:!0,playsInline:!0,muted:!0,className:"w-full h-full object-cover scale-x-[-1]"})})},he=({mode:u="audio",scenario:r,onBack:n,onStart:o,title:c,startButtonLabel:x="Training starten",icon:l,extraContent:p=null,disabled:w=!1})=>{const[j,D]=t.useState(window.innerWidth<768);t.useEffect(()=>{const v=()=>D(window.innerWidth<768);return window.addEventListener("resize",v),()=>window.removeEventListener("resize",v)},[]);const[k,M]=t.useState([]),[N,y]=t.useState([]),[s,a]=t.useState(null),[f,E]=t.useState(null),[A,L]=t.useState(!0),[_,R]=t.useState(null),[T,i]=t.useState(null),[h,z]=t.useState(!1),S=t.useRef(0),C=t.useRef(!1),F=t.useRef(null),I=t.useRef(null);ae();const d=u==="audio-video";F.current=s,I.current=f;const b=t.useCallback(async(v=!1)=>{if(!C.current&&!(v&&Date.now()-S.current<2e3)){C.current=!0,S.current=Date.now(),L(!0),R(null),d&&i(null);try{const g={audio:!0};d&&(g.video=!0),(await navigator.mediaDevices.getUserMedia(g)).getTracks().forEach(m=>m.stop());const O=await navigator.mediaDevices.enumerateDevices();console.log("[DeviceSetupPage] All detected devices:",O.map(m=>({kind:m.kind,label:m.label||"(no label)",deviceId:m.deviceId?.substring(0,8)+"..."})));const $=O.filter(m=>m.kind==="audioinput"),P=O.filter(m=>m.kind==="videoinput");if(console.log("[DeviceSetupPage] Audio inputs:",$.length,"Video inputs:",P.length),$.length===0)console.warn("[DeviceSetupPage] No audioinput devices found"),R("Kein Mikrofon gefunden"),M([]);else if(M($),!F.current){const m=$.find(V=>V.deviceId==="default")||$[0];a(m.deviceId)}if(d){if(P.length===0)i("Keine Kamera gefunden"),y([]);else if(y(P),!I.current){const m=P.find(V=>V.deviceId==="default")||P[0];E(m.deviceId)}}}catch(g){console.error("Error loading devices:",g),g.name==="NotAllowedError"||g.name==="PermissionDeniedError"?(R("Zugriff verweigert"),d&&i("Zugriff verweigert")):g.name==="NotFoundError"?(R("Kein Mikrofon gefunden"),d&&i("Keine Kamera gefunden")):(R("Fehler beim Laden"),d&&i("Fehler beim Laden"))}finally{L(!1),C.current=!1,S.current=Date.now()}}},[d]);t.useEffect(()=>{b(!1);let v=null;const g=()=>{v&&clearTimeout(v),v=setTimeout(()=>{b(!0)},500)};return navigator.mediaDevices?.addEventListener("devicechange",g),()=>{v&&clearTimeout(v),navigator.mediaDevices?.removeEventListener("devicechange",g)}},[]);const B=()=>{o({selectedMicrophoneId:s,selectedCameraId:d?f:null})},K=s&&!_&&(!d||f&&!T)&&!w;return e.jsxs("div",{className:`p-6 max-w-[640px] mx-auto ${j?"pb-[120px]":"pb-10"}`,children:[e.jsxs("div",{className:"mb-8",children:[e.jsxs("button",{onClick:n,className:"inline-flex items-center gap-2 px-3 py-2 mb-4 border-0 bg-transparent text-slate-600 text-sm cursor-pointer rounded-lg hover:bg-slate-50 transition-colors duration-200",children:[e.jsx(Q,{className:"w-[18px] h-[18px]"}),"Zurück"]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-14 h-14 rounded-[14px] bg-brand-gradient flex items-center justify-center",children:l?e.jsx(l,{className:"w-7 h-7 text-white"}):e.jsx(U,{className:"w-7 h-7 text-white"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-slate-900 m-0",children:c||r?.title||"Geräte einrichten"}),e.jsx("p",{className:"text-sm text-slate-600 mt-1 mb-0",children:d?"Kamera und Mikrofon auswählen":"Mikrofon auswählen und testen"})]})]})]}),A&&e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 px-6 bg-slate-50 rounded-2xl",children:[e.jsx(X,{className:"w-8 h-8 text-primary mb-4 animate-spin"}),e.jsx("p",{className:"text-slate-600 m-0",children:"Geräte werden geladen..."})]}),!A&&e.jsxs(Y.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.3},children:[d&&e.jsxs("div",{className:"p-6 bg-white rounded-2xl border border-slate-200 mb-5",children:[e.jsxs("div",{className:"flex items-center gap-2.5 mb-4",children:[e.jsx(G,{className:"w-[22px] h-[22px] text-primary"}),e.jsx("h3",{className:"text-base font-semibold text-slate-900 m-0",children:"Kamera auswählen"})]}),e.jsx(oe,{type:"video",devices:N,selectedDeviceId:f,onDeviceChange:E,isLoading:A,error:T,onRefresh:b}),f&&!T&&e.jsx(ce,{deviceId:f})]}),e.jsxs("div",{className:"p-6 bg-white rounded-2xl border border-slate-200 mb-6",children:[e.jsxs("div",{className:"flex items-center gap-2.5 mb-4",children:[e.jsx(U,{className:"w-[22px] h-[22px] text-primary"}),e.jsx("h3",{className:"text-base font-semibold text-slate-900 m-0",children:"Mikrofon testen"})]}),e.jsx(ne,{selectedDeviceId:s,onDeviceChange:a,onTestClick:()=>z(!0)})]}),p&&e.jsx("div",{className:"mb-6",children:p}),e.jsx("div",{className:j?"fixed bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-white via-white/95 to-transparent z-[100]":"",children:e.jsxs("button",{onClick:B,disabled:!K,className:`w-full px-6 py-4 rounded-[14px] border-0 text-white text-base font-semibold flex items-center justify-center gap-2.5 transition-all duration-200 ${K?"bg-brand-gradient cursor-pointer shadow-[0_4px_12px_rgba(var(--primary-rgb),0.3)] hover:-translate-y-0.5 hover:shadow-[0_6px_16px_rgba(var(--primary-rgb),0.4)]":"bg-slate-300 cursor-not-allowed shadow-none"}`,children:[x,e.jsx(H,{className:"w-5 h-5"})]})})]}),e.jsx(ie,{isOpen:h,onClose:()=>z(!1),deviceId:s})]})};export{he as D,pe as M};
