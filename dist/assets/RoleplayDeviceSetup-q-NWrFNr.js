import{j as e,M as R,s as C,t as A,L as $,T as z,I as N,u as _,v as k}from"./ui-vendor-Cix6Gssq.js";import{a as b}from"./react-vendor-uDOJF2jQ.js";import{D as B}from"./DeviceSetupPage-C6th1cpI.js";import{w as S}from"./FeatureInfoButton-Ca11wQwo.js";import"./MicrophoneTestDialog-D3h-xqHO.js";import"./utils-BEHD0UYf.js";const F="wss://karriereheld-ws-proxy.onrender.com/ws";async function G(r,l=5e3){if(!r)return{success:!1,error:"No agent ID provided"};const i=`wss://api.elevenlabs.io/v1/convai/conversation?agent_id=${r}`,x=Date.now();return new Promise(d=>{let t=null,c=!1;const a=()=>{if(t){try{t.close()}catch{}t=null}},n=s=>{c||(c=!0,a(),d(s))},o=setTimeout(()=>{n({success:!1,error:"Connection timeout - WebSocket may be blocked by firewall"})},l);try{t=new WebSocket(i),t.onopen=()=>{clearTimeout(o);const s=Date.now()-x;n({success:!0,latency:s})},t.onerror=s=>{clearTimeout(o),n({success:!1,error:"WebSocket connection failed - may be blocked by firewall"})},t.onclose=s=>{clearTimeout(o),c||(s.code===1e3?n({success:!0,latency:Date.now()-x}):n({success:!1,error:`Connection closed: ${s.code} ${s.reason||""}`.trim()}))}}catch(s){clearTimeout(o),n({success:!1,error:s.message||"Failed to create WebSocket connection"})}})}async function D(r,l=5e3){if(!r)return{success:!1,error:"No agent ID provided"};const i=`${F}?agent_id=${r}`,x=Date.now();return new Promise(d=>{let t=null,c=!1;const a=()=>{if(t){try{t.close()}catch{}t=null}},n=s=>{c||(c=!0,a(),d(s))},o=setTimeout(()=>{n({success:!1,error:"Proxy connection timeout"})},l);try{t=new WebSocket(i),t.onopen=()=>{clearTimeout(o);const s=Date.now()-x;n({success:!0,latency:s})},t.onerror=s=>{clearTimeout(o),n({success:!1,error:"Proxy connection failed"})},t.onclose=s=>{clearTimeout(o),c||(s.code===1e3?n({success:!0,latency:Date.now()-x}):n({success:!1,error:`Proxy connection closed: ${s.code}`}))}}catch(s){clearTimeout(o),n({success:!1,error:s.message||"Failed to connect to proxy"})}})}function O(){return typeof WebSocket<"u"}async function U(r){if(!O())return{mode:"proxy",directAvailable:!1,proxyAvailable:!1,error:"Browser unterstützt keine WebSocket-Verbindungen"};const l=await G(r,5e3);if(l.success)return{mode:"websocket",directAvailable:!0,proxyAvailable:!1,directLatency:l.latency};const i=await D(r,5e3);return i.success?{mode:"proxy",directAvailable:!1,proxyAvailable:!0,proxyLatency:i.latency,error:l.error}:{mode:"proxy",directAvailable:!1,proxyAvailable:!1,error:"Alle WebSocket-Verbindungen werden durch Firewall blockiert"}}const K=({mode:r,isChecking:l,latency:i,proxyLatency:x,error:d,onSwitchMode:t,onRetry:c,directAvailable:a,proxyAvailable:n})=>l?e.jsxs("div",{className:"flex items-center gap-2.5 p-3.5 px-4 bg-blue-50 border border-blue-200 rounded-lg",children:[e.jsx($,{className:"w-5 h-5 text-blue-500 animate-spin"}),e.jsx("span",{className:"text-base font-medium text-blue-700",children:"Prüfe Verbindung..."})]}):d&&!a&&!n?e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2.5 p-3.5 px-4 bg-red-50 border border-red-200 rounded-lg",children:[e.jsx(z,{className:"w-5 h-5 text-red-600"}),e.jsx("div",{className:"flex-1",children:e.jsx("span",{className:"text-base font-medium text-red-800",children:"Keine Verbindung möglich"})})]}),e.jsxs("div",{className:"flex items-start gap-2.5 p-3.5 px-4 bg-slate-50 border border-slate-200 rounded-lg",children:[e.jsx(N,{className:"w-4 h-4 text-slate-500 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"text-xs text-slate-600",children:[e.jsx("p",{className:"m-0 font-medium mb-1",children:"WebSocket-Verbindungen blockiert"}),e.jsx("p",{className:"m-0",children:d})]})]}),e.jsxs("button",{onClick:c,className:"flex items-center gap-1.5 text-xs text-slate-500 bg-transparent border-none cursor-pointer underline p-0",children:[e.jsx(_,{className:"w-3 h-3"}),"Verbindung erneut prüfen"]})]}):r==="websocket"?e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2.5 p-3.5 px-4 bg-green-50 border border-green-200 rounded-lg",children:[e.jsx(A,{className:"w-5 h-5 text-green-500"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("span",{className:"text-base font-medium text-green-700",children:"Direkte Echtzeit-Verbindung"}),i&&e.jsxs("span",{className:"text-xs text-green-600 ml-2",children:["(",i,"ms)"]})]}),e.jsx(k,{className:"w-5 h-5 text-green-500"})]}),e.jsx("button",{onClick:()=>t("proxy"),className:"text-xs text-slate-500 bg-transparent border-none cursor-pointer underline text-left p-0",children:"Proxy-Modus testen"})]}):e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2.5 p-3.5 px-4 bg-blue-50 border border-blue-200 rounded-lg",children:[e.jsx(C,{className:"w-5 h-5 text-blue-500"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("span",{className:"text-base font-medium text-blue-700",children:"Proxy-Modus (Echtzeit via Server)"}),x&&e.jsxs("span",{className:"text-xs text-blue-500 ml-2",children:["(",x,"ms)"]})]}),e.jsx(k,{className:"w-5 h-5 text-blue-500"})]}),!a&&e.jsxs("div",{className:"flex items-start gap-2.5 p-3 px-4 bg-slate-50 border border-slate-200 rounded-lg",children:[e.jsx(N,{className:"w-3.5 h-3.5 text-slate-500 flex-shrink-0 mt-0.5"}),e.jsx("div",{className:"text-xs text-slate-600",children:e.jsx("p",{className:"m-0",children:"Direkte Verbindung blockiert. Der Proxy-Server ermöglicht Echtzeit-Gespräche trotz Firewall."})})]}),a&&e.jsx("button",{onClick:()=>t("websocket"),className:"text-xs text-slate-500 bg-transparent border-none cursor-pointer underline text-left p-0",children:"Direkte Verbindung nutzen"})]}),Z=({scenario:r,onBack:l,onStart:i,primaryAccent:x})=>{const[d,t]=b.useState("websocket"),[c,a]=b.useState(!0),[n,o]=b.useState(null),[s,P]=b.useState(null),[L,w]=b.useState(null),[T,h]=b.useState(!1),[v,f]=b.useState(!1);b.useEffect(()=>{j()},[r]);const j=async()=>{a(!0),o(null);try{const u=r?.agent_id||S.getElevenLabsAgentId();if(!u){t("websocket"),o("Keine Agent-ID konfiguriert"),h(!1),f(!1),a(!1);return}const m=await U(u);t(m.mode),h(m.directAvailable),f(m.proxyAvailable),P(m.directLatency||null),w(m.proxyLatency||null),o(m.error||null)}catch(u){console.error("[DeviceSetup] Connection check failed:",u),t("websocket"),o(u.message),h(!1),f(!1)}finally{a(!1)}},I=async u=>{const m=r?.agent_id||S.getElevenLabsAgentId();if(u==="proxy"&&!v&&m){a(!0);const g=await D(m,5e3);if(a(!1),g.success)f(!0),w(g.latency),t("proxy");else{o("Proxy-Verbindung nicht verfügbar: "+g.error);return}}else t(u)},V=()=>{j()},W=({selectedMicrophoneId:u})=>{i({selectedMicrophoneId:u,connectionMode:d})},p=r?.interviewer_profile?.name;let y;d==="proxy"?y=p?`${p} anrufen (Proxy)`:"Gespräch starten (Proxy)":p?y=`${p} anrufen`:y="Gespräch starten";const E=()=>d==="proxy"?e.jsx(C,{className:"w-5 h-5 text-primary"}):e.jsx(A,{className:"w-5 h-5 text-primary"}),M=e.jsxs("div",{className:"p-5 bg-white rounded-xl border border-slate-200",children:[e.jsxs("div",{className:"flex items-center gap-2.5 mb-4",children:[E(),e.jsx("h3",{className:"text-lg font-semibold text-slate-900 m-0",children:"Verbindungsmodus"})]}),e.jsx(K,{mode:d,isChecking:c,latency:s,proxyLatency:L,error:n,onSwitchMode:I,onRetry:V,directAvailable:T,proxyAvailable:v})]});return e.jsx(B,{mode:"audio",scenario:r,onBack:l,onStart:W,title:r?.title,startButtonLabel:y,icon:R,disabled:c,extraContent:M})};export{Z as default};
