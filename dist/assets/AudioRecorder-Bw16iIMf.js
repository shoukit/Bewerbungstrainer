import{j as r,L as U,X as $,b as F,f as P}from"./ui-vendor-CgXEyNXi.js";import{a as e}from"./react-vendor-uDOJF2jQ.js";import{w as q,x as K}from"./index.js";import{w as H,C as O}from"./FeatureInfoButton-H9DAh3rB.js";const G=t=>{const n=Math.floor(t/60),o=Math.floor(t%60);return`${n}:${o.toString().padStart(2,"0")}`},X=[/^untertitel/i,/amara\.org/i,/vielen dank f[Ã¼u]r'?s? zusch/i,/bis zum n[Ã¤a]chsten mal/i,/thank you for watching/i,/subscribe/i,/^\.+$/,/^[â™ªâ™«ðŸŽµðŸŽ¶\s]+$/,/^\s*$/,/^(Ã¤hm?|uhm?|hmm?|ja|nein|ok|okay)\.?\s*$/i],Y=t=>{if(!t||typeof t!="string")return!0;const n=t.trim();if(n.length<10)return!0;for(const o of X)if(o.test(n))return console.log("[AudioRecorder] Filtered hallucination:",n),!0;return!1},Z=({isRecording:t,analyserNode:n})=>{const o=e.useRef(null),a=e.useRef(null);return e.useEffect(()=>{if(!t||!n||!o.current){a.current&&cancelAnimationFrame(a.current);return}const i=o.current,A=i.getContext("2d"),C=n.frequencyBinCount,M=new Uint8Array(C),N=()=>{if(!t)return;n.getByteFrequencyData(M),A.clearRect(0,0,i.width,i.height);const h=50,c=2,I=(i.width-h*c)/(h-1),u=i.height/2;for(let x=0;x<h;x++){const z=Math.floor(x/h*C),p=M[z]||0,g=Math.max(2,p/255*(i.height*.8));A.fillStyle=O.slate[800],A.fillRect(x*(c+I),u-g/2,c,g)}a.current=requestAnimationFrame(N)};return N(),()=>{a.current&&cancelAnimationFrame(a.current)}},[t,n]),r.jsx("canvas",{ref:o,width:200,height:32,className:"flex-1 max-w-[300px] min-w-[80px] sm:min-w-[100px]"})},ee=({onTranscriptReady:t,disabled:n=!1,warmUp:o=!1})=>{const[a,i]=e.useState(!1),[A,C]=e.useState(!1),[M,N]=e.useState(!1),[h,c]=e.useState(0),[I,u]=e.useState(null),[x,z]=e.useState(!1),p=e.useRef(null),g=e.useRef([]),w=e.useRef(null),b=e.useRef(null),d=e.useRef(null),R=e.useRef(null),E=e.useRef(!1),j=e.useRef(0),y=e.useRef(null);e.useEffect(()=>{o&&!x&&(async()=>{try{console.log("[AudioRecorder] Warming up microphone..."),(await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}})).getTracks().forEach(S=>S.stop()),z(!0),console.log("[AudioRecorder] Microphone warm-up complete")}catch(k){console.warn("[AudioRecorder] Warm-up failed:",k.message)}})()},[o,x]);const m=e.useCallback(()=>{b.current&&(clearInterval(b.current),b.current=null),y.current&&(clearInterval(y.current),y.current=null),w.current&&(w.current.getTracks().forEach(l=>l.stop()),w.current=null),d.current&&(d.current.close(),d.current=null),g.current=[],E.current=!1,j.current=0},[]);e.useEffect(()=>m,[m]);const D=async()=>{try{u(null);const l=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}});w.current=l,d.current=new(window.AudioContext||window.webkitAudioContext);const k=d.current.createMediaStreamSource(l);R.current=d.current.createAnalyser(),R.current.fftSize=256,k.connect(R.current);const S=K()||"audio/webm",s=new MediaRecorder(l,{mimeType:S});p.current=s,g.current=[],s.ondataavailable=f=>{f.data.size>0&&g.current.push(f.data)},s.start(100),i(!0),c(0),E.current=!1,j.current=0,b.current=setInterval(()=>{c(f=>f+1)},1e3);const v=new Uint8Array(R.current.frequencyBinCount);y.current=setInterval(()=>{if(R.current){R.current.getByteFrequencyData(v);const f=v.reduce((T,L)=>T+L,0)/v.length;f>j.current&&(j.current=f),f>20&&(E.current=!0)}},100)}catch(l){console.error("[AudioRecorder] Error starting recording:",l),u("Mikrofon-Zugriff verweigert")}},W=e.useCallback(()=>{p.current&&a&&p.current.stop(),m(),i(!1),c(0),u(null)},[a,m]),B=e.useCallback(async()=>{if(!p.current||!a)return;const l=E.current,k=j.current,S=h;if(p.current.stop(),i(!1),b.current&&(clearInterval(b.current),b.current=null),y.current&&(clearInterval(y.current),y.current=null),w.current&&(w.current.getTracks().forEach(s=>s.stop()),w.current=null),d.current&&(d.current.close(),d.current=null),await new Promise(s=>setTimeout(s,100)),g.current.length===0){u("Keine Aufnahme");return}if(S<1){u("Aufnahme zu kurz"),m(),c(0);return}if(!l||k<15){console.log("[AudioRecorder] No speech detected. Peak level:",k),u("Keine Sprache erkannt"),m(),c(0);return}C(!0),u(null);try{const s=p.current?.mimeType||"audio/webm",v=new Blob(g.current,{type:s});if(v.size<1e3)throw new Error("Aufnahme zu kurz");const f=await q(v),T=await H.transcribeAudio(f,s);if(T.transcript){if(Y(T.transcript))throw new Error("Keine verstÃ¤ndliche Sprache erkannt");t(T.transcript),m(),c(0)}else throw new Error("Keine Transkription erhalten")}catch(s){console.error("[AudioRecorder] Transcription error:",s),u(s.message||"Transkription fehlgeschlagen"),m(),c(0)}finally{C(!1)}},[a,h,t,m]);return A?r.jsxs("div",{className:"flex items-center justify-center gap-2 px-4 py-3 bg-slate-100 rounded-full border border-slate-200",children:[r.jsx(U,{size:24,className:"text-slate-500 animate-spin"}),r.jsx("span",{className:"text-base text-slate-500 hidden sm:inline",children:"Wird transkribiert..."})]}):a?r.jsxs("div",{className:"flex items-center gap-2 sm:gap-3 px-2 sm:px-3 py-2 bg-slate-100 rounded-full border border-slate-200",children:[r.jsx("button",{onClick:W,className:"w-10 h-10 sm:w-11 sm:h-11 rounded-full border-none bg-slate-200 text-slate-500 cursor-pointer flex items-center justify-center transition-all shrink-0 hover:bg-slate-300",children:r.jsx($,{size:20,strokeWidth:2.5})}),r.jsx(Z,{isRecording:a,analyserNode:R.current}),r.jsx("span",{className:"font-sans text-base sm:text-lg font-medium text-slate-800 min-w-[40px] text-right shrink-0",children:G(h)}),r.jsx("button",{onClick:B,className:"w-10 h-10 sm:w-11 sm:h-11 rounded-full border-none bg-primary text-white cursor-pointer flex items-center justify-center transition-all shrink-0 hover:opacity-90",children:r.jsx(F,{size:20,strokeWidth:2.5})})]}):r.jsxs("div",{className:"flex items-center gap-2",children:[I&&r.jsx("span",{className:"text-sm text-red-500 hidden sm:inline",children:I}),r.jsx("button",{onClick:D,disabled:n,title:"Spracheingabe",className:`w-11 h-11 sm:w-[52px] sm:h-[52px] rounded-full border-none bg-slate-800 text-white flex items-center justify-center transition-all ${n?"cursor-not-allowed opacity-50":"cursor-pointer hover:opacity-90"}`,children:r.jsx(P,{size:22,className:"sm:w-6 sm:h-6"})})]})};export{ee as A};
