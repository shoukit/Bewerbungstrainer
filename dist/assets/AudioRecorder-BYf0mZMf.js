import{j as r,L as U,X as F,b as $,e as P}from"./ui-vendor-w3QMwUw1.js";import{a as e}from"./react-vendor-uDOJF2jQ.js";import{w as q,x as K}from"./index.js";import{w as H,C as O}from"./FeatureInfoButton-DBIrK8PE.js";const G=t=>{const n=Math.floor(t/60),i=Math.floor(t%60);return`${n}:${i.toString().padStart(2,"0")}`},X=[/^untertitel/i,/amara\.org/i,/vielen dank f[Ã¼u]r'?s? zusch/i,/bis zum n[Ã¤a]chsten mal/i,/thank you for watching/i,/subscribe/i,/^\.+$/,/^[â™ªâ™«ðŸŽµðŸŽ¶\s]+$/,/^\s*$/,/^(Ã¤hm?|uhm?|hmm?|ja|nein|ok|okay)\.?\s*$/i],Y=t=>{if(!t||typeof t!="string")return!0;const n=t.trim();if(n.length<10)return!0;for(const i of X)if(i.test(n))return console.log("[AudioRecorder] Filtered hallucination:",n),!0;return!1},Z=({isRecording:t,analyserNode:n})=>{const i=e.useRef(null),a=e.useRef(null);return e.useEffect(()=>{if(!t||!n||!i.current){a.current&&cancelAnimationFrame(a.current);return}const u=i.current,A=u.getContext("2d"),C=n.frequencyBinCount,M=new Uint8Array(C),N=()=>{if(!t)return;n.getByteFrequencyData(M),A.clearRect(0,0,u.width,u.height);const p=50,c=2,T=(u.width-p*c)/(p-1),l=u.height/2;for(let w=0;w<p;w++){const z=Math.floor(w/p*C),g=M[z]||0,x=Math.max(2,g/255*(u.height*.8));A.fillStyle=O.slate[800],A.fillRect(w*(c+T),l-x/2,c,x)}a.current=requestAnimationFrame(N)};return N(),()=>{a.current&&cancelAnimationFrame(a.current)}},[t,n]),r.jsx("canvas",{ref:i,width:200,height:32,className:"flex-1 max-w-[300px] min-w-[80px] sm:min-w-[100px]"})},ee=({onTranscriptReady:t,disabled:n=!1,warmUp:i=!1})=>{const[a,u]=e.useState(!1),[A,C]=e.useState(!1),[M,N]=e.useState(!1),[p,c]=e.useState(0),[T,l]=e.useState(null),[w,z]=e.useState(!1),g=e.useRef(null),x=e.useRef([]),b=e.useRef(null),R=e.useRef(null),m=e.useRef(null),y=e.useRef(null),E=e.useRef(!1),j=e.useRef(0),k=e.useRef(null);e.useEffect(()=>{i&&!w&&(async()=>{try{console.log("[AudioRecorder] Warming up microphone..."),(await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}})).getTracks().forEach(S=>S.stop()),z(!0),console.log("[AudioRecorder] Microphone warm-up complete")}catch(v){console.warn("[AudioRecorder] Warm-up failed:",v.message)}})()},[i,w]);const h=e.useCallback(()=>{R.current&&(clearInterval(R.current),R.current=null),k.current&&(clearInterval(k.current),k.current=null),b.current&&(b.current.getTracks().forEach(f=>f.stop()),b.current=null),m.current&&(m.current.close(),m.current=null),x.current=[],E.current=!1,j.current=0},[]);e.useEffect(()=>h,[h]);const D=async()=>{try{l(null);const f=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}});b.current=f,m.current=new(window.AudioContext||window.webkitAudioContext);const v=m.current.createMediaStreamSource(f);y.current=m.current.createAnalyser(),y.current.fftSize=256,v.connect(y.current);const S=K()||"audio/webm",s=new MediaRecorder(f,{mimeType:S});g.current=s,x.current=[],s.ondataavailable=d=>{d.data.size>0&&x.current.push(d.data)},s.start(100),u(!0),c(0),E.current=!1,j.current=0,R.current=setInterval(()=>{c(d=>d+1)},1e3);const o=new Uint8Array(y.current.frequencyBinCount);k.current=setInterval(()=>{if(y.current){y.current.getByteFrequencyData(o);const d=o.reduce((I,L)=>I+L,0)/o.length;d>j.current&&(j.current=d),d>20&&(E.current=!0)}},100)}catch(f){console.error("[AudioRecorder] Error starting recording:",f),l("Mikrofon-Zugriff verweigert")}},W=e.useCallback(()=>{g.current&&a&&g.current.stop(),h(),u(!1),c(0),l(null)},[a,h]),B=e.useCallback(async()=>{if(!g.current||!a)return;const f=E.current,v=j.current,S=p;if(g.current.stop(),u(!1),R.current&&(clearInterval(R.current),R.current=null),k.current&&(clearInterval(k.current),k.current=null),b.current&&(b.current.getTracks().forEach(s=>s.stop()),b.current=null),m.current&&(m.current.close(),m.current=null),await new Promise(s=>setTimeout(s,100)),x.current.length===0){l("Keine Aufnahme");return}if(S<1){l("Aufnahme zu kurz"),h(),c(0);return}if(!f||v<15){console.log("[AudioRecorder] No speech detected. Peak level:",v),l("Keine Sprache erkannt"),h(),c(0);return}C(!0),l(null);try{const s=g.current?.mimeType||"audio/webm",o=new Blob(x.current,{type:s});if(o.size<1e3)throw new Error("Aufnahme zu kurz");const d=await q(o),I=await H.transcribeAudio(d,s);if(I.transcript){if(Y(I.transcript))throw new Error("Keine verstÃ¤ndliche Sprache erkannt");t(I.transcript),h(),c(0)}else throw new Error("Keine Transkription erhalten")}catch(s){console.error("[AudioRecorder] Transcription error:",s);let o=s.message||"Transkription fehlgeschlagen";(o.includes("Failed to fetch")||o.includes("NetworkError"))&&(o="Keine Internetverbindung"),l(o),h(),c(0)}finally{C(!1)}},[a,p,t,h]);return A?r.jsxs("div",{className:"flex items-center justify-center gap-2 px-4 py-3 bg-slate-100 rounded-full border border-slate-200",children:[r.jsx(U,{size:24,className:"text-slate-500 animate-spin"}),r.jsx("span",{className:"text-base text-slate-500 hidden sm:inline",children:"Wird transkribiert..."})]}):a?r.jsxs("div",{className:"flex items-center gap-2 sm:gap-3 px-2 sm:px-3 py-2 bg-slate-100 rounded-full border border-slate-200",children:[r.jsx("button",{onClick:W,className:"w-10 h-10 sm:w-11 sm:h-11 rounded-full border-none bg-slate-200 text-slate-500 cursor-pointer flex items-center justify-center transition-all shrink-0 hover:bg-slate-300",children:r.jsx(F,{size:20,strokeWidth:2.5})}),r.jsx(Z,{isRecording:a,analyserNode:y.current}),r.jsx("span",{className:"font-sans text-base sm:text-lg font-medium text-slate-800 min-w-[40px] text-right shrink-0",children:G(p)}),r.jsx("button",{onClick:B,className:"w-10 h-10 sm:w-11 sm:h-11 rounded-full border-none bg-primary text-white cursor-pointer flex items-center justify-center transition-all shrink-0 hover:opacity-90",children:r.jsx($,{size:20,strokeWidth:2.5})})]}):r.jsxs("div",{className:"flex items-center gap-2",children:[T&&r.jsx("span",{className:"text-sm text-red-500 hidden sm:inline",children:T}),r.jsx("button",{onClick:D,disabled:n,title:"Spracheingabe",className:`w-11 h-11 sm:w-[52px] sm:h-[52px] rounded-full border-none bg-slate-800 text-white flex items-center justify-center transition-all ${n?"cursor-not-allowed opacity-50":"cursor-pointer hover:opacity-90"}`,children:r.jsx(P,{size:22,className:"sm:w-6 sm:h-6"})})]})};export{ee as A};
