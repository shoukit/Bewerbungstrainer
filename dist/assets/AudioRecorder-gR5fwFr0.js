import{j as r,l as M,X as B,n as D,p as $}from"./ui-vendor-B9DEMv6g.js";import{a as e}from"./react-vendor-uDOJF2jQ.js";import{w as F,x as L}from"./index.js";import{w as q}from"./FeatureInfoButton-ZHD_p0zG.js";const W=n=>{const s=Math.floor(n/60),t=Math.floor(n%60);return`${s}:${t.toString().padStart(2,"0")}`},K=[/^untertitel/i,/amara\.org/i,/vielen dank f[Ã¼u]r'?s? zusch/i,/bis zum n[Ã¤a]chsten mal/i,/thank you for watching/i,/subscribe/i,/^\.+$/,/^[â™ªâ™«ðŸŽµðŸŽ¶\s]+$/,/^\s*$/,/^(Ã¤hm?|uhm?|hmm?|ja|nein|ok|okay)\.?\s*$/i],P=n=>{if(!n||typeof n!="string")return!0;const s=n.trim();if(s.length<10)return!0;for(const t of K)if(t.test(s))return console.log("[AudioRecorder] Filtered hallucination:",s),!0;return!1},U=({isRecording:n,analyserNode:s})=>{const t=e.useRef(null),d=e.useRef(null);return e.useEffect(()=>{if(!n||!s||!t.current){d.current&&cancelAnimationFrame(d.current);return}const g=t.current,y=g.getContext("2d"),k=s.frequencyBinCount,u=new Uint8Array(k),A=()=>{if(!n)return;s.getByteFrequencyData(u),y.clearRect(0,0,g.width,g.height);const c=50,l=2,w=(g.width-c*l)/(c-1),m=g.height/2;for(let i=0;i<c;i++){const o=Math.floor(i/c*k),h=u[o]||0,b=Math.max(2,h/255*(g.height*.8));y.fillStyle="#1e293b",y.fillRect(i*(l+w),m-b/2,l,b)}d.current=requestAnimationFrame(A)};return A(),()=>{d.current&&cancelAnimationFrame(d.current)}},[n,s]),r.jsx("canvas",{ref:t,width:200,height:32,className:"flex-1 max-w-[300px] min-w-[80px] sm:min-w-[100px]"})},Y=({onTranscriptReady:n,disabled:s=!1})=>{const[t,d]=e.useState(!1),[g,y]=e.useState(!1),[k,u]=e.useState(0),[A,c]=e.useState(null),l=e.useRef(null),w=e.useRef([]),m=e.useRef(null),i=e.useRef(null),o=e.useRef(null),h=e.useRef(null),b=e.useRef(!1),j=e.useRef(0),R=e.useRef(null),p=e.useCallback(()=>{i.current&&(clearInterval(i.current),i.current=null),R.current&&(clearInterval(R.current),R.current=null),m.current&&(m.current.getTracks().forEach(x=>x.stop()),m.current=null),o.current&&(o.current.close(),o.current=null),w.current=[],b.current=!1,j.current=0},[]);e.useEffect(()=>p,[p]);const N=async()=>{try{c(null);const x=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}});m.current=x,o.current=new(window.AudioContext||window.webkitAudioContext);const S=o.current.createMediaStreamSource(x);h.current=o.current.createAnalyser(),h.current.fftSize=256,S.connect(h.current);const T=L()||"audio/webm",a=new MediaRecorder(x,{mimeType:T});l.current=a,w.current=[],a.ondataavailable=f=>{f.data.size>0&&w.current.push(f.data)},a.start(100),d(!0),u(0),b.current=!1,j.current=0,i.current=setInterval(()=>{u(f=>f+1)},1e3);const v=new Uint8Array(h.current.frequencyBinCount);R.current=setInterval(()=>{if(h.current){h.current.getByteFrequencyData(v);const f=v.reduce((C,E)=>C+E,0)/v.length;f>j.current&&(j.current=f),f>20&&(b.current=!0)}},100)}catch(x){console.error("[AudioRecorder] Error starting recording:",x),c("Mikrofon-Zugriff verweigert")}},z=e.useCallback(()=>{l.current&&t&&l.current.stop(),p(),d(!1),u(0),c(null)},[t,p]),I=e.useCallback(async()=>{if(!l.current||!t)return;const x=b.current,S=j.current,T=k;if(l.current.stop(),d(!1),i.current&&(clearInterval(i.current),i.current=null),R.current&&(clearInterval(R.current),R.current=null),m.current&&(m.current.getTracks().forEach(a=>a.stop()),m.current=null),o.current&&(o.current.close(),o.current=null),await new Promise(a=>setTimeout(a,100)),w.current.length===0){c("Keine Aufnahme");return}if(T<1){c("Aufnahme zu kurz"),p(),u(0);return}if(!x||S<15){console.log("[AudioRecorder] No speech detected. Peak level:",S),c("Keine Sprache erkannt"),p(),u(0);return}y(!0),c(null);try{const a=l.current?.mimeType||"audio/webm",v=new Blob(w.current,{type:a});if(v.size<1e3)throw new Error("Aufnahme zu kurz");const f=await F(v),C=await q.transcribeAudio(f,a);if(C.transcript){if(P(C.transcript))throw new Error("Keine verstÃ¤ndliche Sprache erkannt");n(C.transcript),p(),u(0)}else throw new Error("Keine Transkription erhalten")}catch(a){console.error("[AudioRecorder] Transcription error:",a),c(a.message||"Transkription fehlgeschlagen"),p(),u(0)}finally{y(!1)}},[t,k,n,p]);return g?r.jsxs("div",{className:"flex items-center justify-center gap-2 px-4 py-3 bg-slate-100 rounded-full border border-slate-200",children:[r.jsx(M,{size:24,className:"text-slate-500 animate-spin"}),r.jsx("span",{className:"text-base text-slate-500 hidden sm:inline",children:"Wird transkribiert..."})]}):t?r.jsxs("div",{className:"flex items-center gap-2 sm:gap-3 px-2 sm:px-3 py-2 bg-slate-100 rounded-full border border-slate-200",children:[r.jsx("button",{onClick:z,className:"w-10 h-10 sm:w-11 sm:h-11 rounded-full border-none bg-slate-200 text-slate-500 cursor-pointer flex items-center justify-center transition-all shrink-0 hover:bg-slate-300",children:r.jsx(B,{size:20,strokeWidth:2.5})}),r.jsx(U,{isRecording:t,analyserNode:h.current}),r.jsx("span",{className:"font-sans text-base sm:text-lg font-medium text-slate-800 min-w-[40px] text-right shrink-0",children:W(k)}),r.jsx("button",{onClick:I,className:"w-10 h-10 sm:w-11 sm:h-11 rounded-full border-none bg-primary text-white cursor-pointer flex items-center justify-center transition-all shrink-0 hover:opacity-90",children:r.jsx(D,{size:20,strokeWidth:2.5})})]}):r.jsxs("div",{className:"flex items-center gap-2",children:[A&&r.jsx("span",{className:"text-sm text-red-500 hidden sm:inline",children:A}),r.jsx("button",{onClick:N,disabled:s,title:"Spracheingabe",className:`w-11 h-11 sm:w-[52px] sm:h-[52px] rounded-full border-none bg-slate-800 text-white flex items-center justify-center transition-all ${s?"cursor-not-allowed opacity-50":"cursor-pointer hover:opacity-90"}`,children:r.jsx($,{size:22,className:"sm:w-6 sm:h-6"})})]})};export{Y as A};
